// Prisma Schema for Anime Flow Video Site

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== 用户相关 ====================

model User {
  id            String    @id @default(dbgenerated("nextval('user_id_seq')::text"))
  email         String    @unique
  emailVerified DateTime?
  username       String    @unique
  displayUsername String?  // Better Auth username 插件展示名（与 username 可不同）
  password      String?
  nickname      String?
  avatar        String?
  bio           String?
  pronouns      String?   // 代词 (he/him, she/her, they/them, etc.)
  website       String?   // 个人网站
  location      String?   // 所在地
  socialLinks   Json?     // 社交账号 { twitter?: string, github?: string, ... }
  role          Role      @default(USER)
  canUpload     Boolean   @default(false)  // 是否可以投稿（ADMIN/OWNER 默认可以）
  adminScopes   Json?     // 管理员权限范围 ["video:moderate", "user:manage", ...]
  isBanned      Boolean   @default(false)  // 是否被封禁
  banReason     String?   // 封禁原因
  bannedAt      DateTime? // 封禁时间
  lastIpLocation  String?  // 最后一次 IP 属地
  adsEnabled    Boolean   @default(true)   // 是否加载广告（站长/管理员可在后台关闭某用户的广告）
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  loginSessions    LoginSession[]
  videos           Video[]
  series           Series[]
  favorites        Favorite[]
  watchHistory     WatchHistory[]
  likes            Like[]
  dislikes         Dislike[]
  confused         Confused[]
  playlists        Playlist[]
  comments         Comment[]         @relation("CommentAuthor")
  commentRepliesTo Comment[]         @relation("CommentReplyTo")
  commentReactions CommentReaction[]
  devices          UserDevice[]
  searchRecords    SearchRecord[]

  // 游戏相关
  games              Game[]
  gameFavorites      GameFavorite[]
  gameLikes          GameLike[]
  gameDislikes       GameDislike[]
  gameComments       GameComment[]    @relation("GameCommentAuthor")
  gameCommentReplies    GameComment[]    @relation("GameCommentReplyTo")
  gameCommentReactions  GameCommentReaction[]

  @@index([email])
  @@index([username])
}

enum Role {
  USER
  ADMIN
  OWNER  // 站长，拥有最高权限
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  password          String? @db.Text // Better Auth credential 密码（bcrypt）

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String    @id @default(cuid())
  sessionToken String    @unique
  userId       String
  expires      DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// 登录会话追踪（用于 JWT 策略下的会话管理）
model LoginSession {
  id             String   @id @default(cuid())
  userId         String
  jti            String   @unique // JWT ID，用于撤销
  
  // 登录信息
  deviceType     String?  // desktop, mobile, tablet
  os             String?  // Windows, iOS, Android
  osVersion      String?
  browser        String?  // Chrome, Safari, Firefox
  browserVersion String?
  brand          String?  // Apple, Samsung
  model          String?  // iPhone 15
  userAgent      String?
  ipv4Address    String?
  ipv4Location   String?
  ipv6Address    String?
  ipv6Location   String?
  
  isRevoked      Boolean  @default(false) // 是否已撤销
  revokedAt      DateTime?
  
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  lastActiveAt   DateTime @default(now())
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([jti])
  @@index([lastActiveAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Better Auth 验证表（邮箱验证、重置密码等）
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@index([expiresAt])
}

// 邮件验证码
model VerificationCode {
  id        String           @id @default(cuid())
  email     String
  code      String
  type      VerificationType
  expiresAt DateTime
  used      Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([email, type])
  @@index([expiresAt])
}

enum VerificationType {
  REGISTER
  LOGIN
  RESET_PASSWORD
  CHANGE_EMAIL
}

// ==================== 视频相关 ====================

model Video {
  id          String      @id // 随机 6 位数字 ID (000000-999999)
  title       String
  description String?     @db.Text
  coverUrl    String?     // 可选，不填则显示默认封面
  videoUrl    String
  duration    Int?
  views       Int         @default(0)
  status      VideoStatus @default(PENDING)
  pages       Json?       // B站分P信息 [{ page: number, title: string, cid?: number }]
  
  // 扩展信息 (结构化)
  extraInfo   Json?       // { 
                          //   intro?: string,           // 作品介绍
                          //   episodes?: { title: string, content: string }[], // 剧集介绍
                          //   author?: string,          // 原作者
                          //   authorIntro?: string,     // 作者介绍
                          //   keywords?: string[],      // 搜索关键词
                          //   downloads?: { name: string, url: string, password?: string }[], // 下载链接
                          //   relatedVideos?: string[], // 相关视频标题
                          //   notices?: { type: 'info'|'success'|'warning'|'error', content: string }[] // 公告
                          // }
  
  tags        TagOnVideo[]
  
  uploaderId  String
  uploader    User        @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  
  // 合集关联
  seriesEpisodes SeriesEpisode[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  favorites     Favorite[]
  watchHistory  WatchHistory[]
  likes         Like[]
  dislikes      Dislike[]
  confused      Confused[]
  playlistItems PlaylistItem[]
  comments      Comment[]

  @@index([uploaderId])
  @@index([status])
  @@index([createdAt])
}

// 合集/剧集
model Series {
  id           String   @id @default(cuid())
  title        String
  description  String?  @db.Text
  coverUrl     String?  // 合集封面
  downloadUrl  String?  // 下载链接
  downloadNote String?  @db.Text // 下载提示
  
  creatorId   String
  creator     User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  episodes    SeriesEpisode[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([creatorId])
  @@index([createdAt])
}

// 合集-视频关联（剧集）
model SeriesEpisode {
  id          String   @id @default(cuid())
  seriesId    String
  videoId     String
  episodeNum  Int      // 集数
  episodeTitle String? // 集标题（可选，默认使用视频标题）
  
  series      Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@unique([seriesId, videoId])
  @@unique([seriesId, episodeNum])
  @@index([seriesId])
  @@index([videoId])
}

enum VideoStatus {
  PENDING
  PUBLISHED
  REJECTED
  DELETED
}

// ==================== 游戏相关 ====================

model Game {
  id          String      @id // 随机 6 位数字 ID (000000-999999)
  title       String      // 游戏标题
  description String?     @db.Text // 游戏介绍
  coverUrl    String?     // 封面图

  // 游戏元信息
  gameType    String?     // 游戏类型 (ADV, SLG, RPG, ACT, etc.)
  isFree      Boolean     @default(true) // 是否免费
  version     String?     // 版本号 (e.g., "Ver1.0.3")

  // 扩展信息 (结构化 JSON)
  extraInfo   Json?       // {
                          //   originalName?: string,            // 原作名
                          //   originalAuthor?: string,          // 原作者
                          //   authorUrl?: string,               // 作者链接
                          //   fileSize?: string,                // 文件大小 (e.g., "2.19 GB")
                          //   platforms?: string[],             // 支持平台 ["PC", "Android"]
                          //   screenshots?: string[],           // 游戏截图 URL 列表
                          //   characterIntro?: string,          // 角色介绍
                          //   downloads?: { name: string, url: string, password?: string }[],
                          //   keywords?: string[],              // 搜索关键词
                          //   notices?: { type: 'info'|'success'|'warning'|'error', content: string }[]
                          // }

  views       Int         @default(0)
  status      VideoStatus @default(PENDING) // 复用审核状态枚举

  tags        TagOnGame[]

  uploaderId  String
  uploader    User        @relation(fields: [uploaderId], references: [id], onDelete: Cascade)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  favorites     GameFavorite[]
  likes         GameLike[]
  dislikes      GameDislike[]
  comments      GameComment[]

  @@index([uploaderId])
  @@index([status])
  @@index([createdAt])
  @@index([gameType])
}

model GameFavorite {
  id        String   @id @default(cuid())
  userId    String
  gameId    String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  game  Game  @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@index([userId])
  @@index([gameId])
}

model GameLike {
  id        String   @id @default(cuid())
  userId    String
  gameId    String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  game  Game  @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@index([userId])
  @@index([gameId])
}

model GameDislike {
  id        String   @id @default(cuid())
  userId    String
  gameId    String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  game  Game  @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@index([userId])
  @@index([gameId])
}

model GameComment {
  id            String   @id @default(cuid())
  content       String   @db.Text
  userId        String?
  gameId        String
  parentId      String?
  replyToUserId String?

  guestName     String?
  guestEmail    String?
  guestWebsite  String?

  ipv4Address   String?
  ipv4Location  String?
  ipv6Address   String?
  ipv6Location  String?
  deviceInfo    Json?
  userAgent     String?

  likes     Int      @default(0)
  dislikes  Int      @default(0)

  isEdited  Boolean  @default(false)
  isPinned  Boolean  @default(false)
  isDeleted Boolean  @default(false)
  isHidden  Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User?          @relation("GameCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  game        Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)
  parent      GameComment?   @relation("GameCommentReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies     GameComment[]  @relation("GameCommentReplies")
  replyToUser User?          @relation("GameCommentReplyTo", fields: [replyToUserId], references: [id], onDelete: SetNull)
  reactions   GameCommentReaction[]

  @@index([gameId, createdAt])
  @@index([gameId, likes])
  @@index([userId])
  @@index([parentId])
}


model GameCommentReaction {
  id        String   @id @default(cuid())
  userId    String
  commentId String
  isLike    Boolean
  createdAt DateTime @default(now())

  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment GameComment       @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

model Tag {
  id        String       @id @default(cuid())
  name      String       @unique
  slug      String       @unique
  createdAt DateTime     @default(now())

  videos TagOnVideo[]
  games  TagOnGame[]

  @@index([slug])
}

model TagOnVideo {
  videoId String
  tagId   String
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([videoId, tagId])
  @@index([tagId])
}

model TagOnGame {
  gameId String
  tagId  String
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([gameId, tagId])
  @@index([tagId])
}

// ==================== 用户交互 ====================

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  videoId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  videoId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

model Dislike {
  id        String   @id @default(cuid())
  userId    String
  videoId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

model Confused {
  id        String   @id @default(cuid())
  userId    String
  videoId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

model WatchHistory {
  id         String   @id @default(cuid())
  userId     String
  videoId    String
  progress   Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
  @@index([updatedAt])
}

model Playlist {
  id          String   @id @default(cuid())
  name        String
  description String?
  isPublic    Boolean  @default(true)
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items PlaylistItem[]

  @@index([userId])
}

model PlaylistItem {
  id         String   @id @default(cuid())
  playlistId String
  videoId    String
  sortOrder  Int      @default(0)
  addedAt    DateTime @default(now())

  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  video    Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([playlistId, videoId])
  @@index([playlistId])
  @@index([videoId])
}

// ==================== 评论系统 ====================

model Comment {
  id            String   @id @default(cuid())
  content       String   @db.Text
  userId        String?  // 可选，匿名评论时为 null
  videoId       String
  parentId      String?  // 回复的父评论 ID（顶级评论的 ID）
  replyToUserId String?  // 回复的目标用户 ID（用于 @用户名 显示）
  
  // 访客信息（匿名评论时使用）
  guestName     String?  // 访客昵称
  guestEmail    String?  // 访客邮箱
  guestWebsite  String?  // 访客网址
  
  ipv4Address   String?
  ipv4Location  String?
  ipv6Address   String?
  ipv6Location  String?
  deviceInfo    Json?
  userAgent     String?
  
  likes     Int      @default(0)
  dislikes  Int      @default(0)
  
  isEdited  Boolean  @default(false)
  isPinned  Boolean  @default(false)
  isDeleted Boolean  @default(false) // 软删除
  isHidden  Boolean  @default(false) // 后台隐藏
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User?         @relation("CommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  video       Video         @relation(fields: [videoId], references: [id], onDelete: Cascade)
  parent      Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies     Comment[]     @relation("CommentReplies")
  replyToUser User?         @relation("CommentReplyTo", fields: [replyToUserId], references: [id], onDelete: SetNull)
  reactions   CommentReaction[]

  @@index([videoId, createdAt])
  @@index([videoId, likes])
  @@index([userId])
  @@index([parentId])
}

model UserDevice {
  id             String   @id @default(cuid())
  userId         String
  fingerprint    String
  deviceType     String?  // desktop, mobile, tablet
  os             String?  // Windows, iOS, Android
  osVersion      String?
  browser        String?  // Chrome, Safari, Firefox
  browserVersion String?
  brand          String?  // Apple, Samsung, Xiaomi
  model          String?  // iPhone 15, Galaxy S24
  userAgent      String?
  ipv4Address    String?
  ipv4Location   String?
  ipv6Address    String?
  ipv6Location   String?
  lastActiveAt   DateTime @default(now())
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fingerprint])
  @@index([userId])
  @@index([lastActiveAt])
}

model CommentReaction {
  id        String   @id @default(cuid())
  userId    String
  commentId String
  isLike    Boolean  // true = 赞, false = 踩
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

// ==================== 搜索记录 ====================

model SearchRecord {
  id        String   @id @default(cuid())
  keyword   String
  userId    String?  // 可选，匿名用户也可以记录
  resultCount Int    @default(0) // 搜索结果数量
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([keyword])
  @@index([createdAt])
  @@index([userId])
}

// ==================== 网站配置 ====================

model SiteConfig {
  id        String   @id @default("default") // 单例模式，只有一条记录
  
  // 基本信息
  siteName        String   @default("My Site")
  siteUrl         String?  // 站点 URL（优先级高于 NEXT_PUBLIC_APP_URL 环境变量）
  siteDescription String?  @db.Text
  siteLogo        String?  // Logo URL
  siteFavicon     String?  // Favicon URL
  siteKeywords    String?  // SEO 关键词，逗号分隔
  
  // SEO / 验证
  googleVerification  String?  // Google Search Console 验证码
  githubUrl           String?  // GitHub 仓库链接（页脚显示）
  securityEmail       String?  // 安全联系邮箱（security.txt 用）
  
  // 公告
  announcement    String?  @db.Text  // 公告内容（支持 Markdown）
  announcementEnabled Boolean @default(false)
  
  // 功能开关
  allowRegistration   Boolean @default(true)   // 允许注册
  allowUpload         Boolean @default(true)   // 允许上传
  allowComment        Boolean @default(true)   // 允许评论
  requireEmailVerify  Boolean @default(false)  // 注册需要邮箱验证
  
  // 内容设置
  videosPerPage       Int     @default(20)     // 每页视频数
  commentsPerPage     Int     @default(20)     // 每页评论数
  maxUploadSize       Int     @default(500)    // 最大上传大小 (MB)
  allowedVideoFormats String  @default("mp4,webm,m3u8") // 允许的视频格式
  
  // 联系方式
  contactEmail    String?
  socialLinks     Json?    // { github?: string, twitter?: string, discord?: string, ... }
  
  // 页脚
  footerText      String?  @db.Text  // 自定义页脚文本
  footerLinks     Json?    // [{ label: string, url: string }]
  
  // ICP 备案
  icpBeian        String?  // ICP 备案号
  publicSecurityBeian String? // 公安备案号
  
  // 广告系统（统一管理）
  adsEnabled  Boolean @default(false)  // 全站是否展示广告位
  adScript    String? @db.Text         // @deprecated 已废弃，保留字段兼容旧数据
  
  // 广告门（用户需点击广告并返回算一次，满 N 次可 Y 小时内关闭广告门）
  adGateEnabled       Boolean @default(false)  // 是否启用广告门
  adGateViewsRequired Int     @default(3)      // 需观看/点击次数
  adGateHours         Int     @default(12)     // 达成后免广告时长（小时）
  
  // 广告列表（统一管理，广告门和页面广告位共用）
  // [{ title, platform, url, description, imageUrl, weight, enabled }]
  sponsorAds          Json?

  // 对象存储
  storageProvider     String   @default("local") // local | s3 | r2 | minio | oss | cos
  storageEndpoint     String?  // S3 兼容端点 URL
  storageBucket       String?  // 存储桶名称
  storageRegion       String?  // 区域
  storageAccessKey    String?  // Access Key ID
  storageSecretKey    String?  // Secret Access Key
  storageCustomDomain String?  // 自定义域名（公开访问地址）
  storagePathPrefix   String?  // 存储路径前缀

  // 数据备份
  backupEnabled         Boolean @default(false)  // 是否启用自动备份
  backupIntervalHours   Int     @default(24)     // 自动备份间隔（小时）
  backupRetentionDays   Int     @default(30)     // 备份保留天数
  backupIncludeUploads  Boolean @default(true)   // 是否包含 uploads 目录
  backupIncludeConfig   Boolean @default(true)   // 是否包含配置文件
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== 数据备份 ====================

model BackupRecord {
  id            String       @id @default(cuid())
  filename      String
  size          BigInt       @default(0)        // 文件大小（字节）
  type          BackupType   @default(MANUAL)
  status        BackupStatus @default(PENDING)
  errorMessage  String?      @db.Text
  storagePath   String?                         // 对象存储中的 key
  includes      Json?                           // { database: true, uploads: true, config: true }
  createdAt     DateTime     @default(now())
  completedAt   DateTime?

  @@index([createdAt])
  @@index([status])
}

enum BackupType {
  AUTO
  MANUAL
}

enum BackupStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// ==================== 友情链接 ====================

model FriendLink {
  id          String   @id @default(cuid())
  name        String                         // 站点名称
  url         String                         // 站点链接
  logo        String?                        // 站点 logo URL
  description String?                        // 站点描述
  sort        Int      @default(0)           // 排序（越大越靠前）
  visible     Boolean  @default(true)        // 是否显示
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sort])
}
