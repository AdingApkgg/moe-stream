// Prisma Schema for Anime Flow Video Site

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== 用户相关 ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  username      String    @unique
  password      String?
  nickname      String?
  avatar        String?
  bio           String?
  pronouns      String?   // 代词 (he/him, she/her, they/them, etc.)
  website       String?   // 个人网站
  location      String?   // 所在地
  socialLinks   Json?     // 社交账号 { twitter?: string, github?: string, ... }
  role          Role      @default(USER)
  canUpload     Boolean   @default(false)  // 是否可以投稿（ADMIN/OWNER 默认可以）
  adminScopes   Json?     // 管理员权限范围 ["video:moderate", "user:manage", ...]
  isBanned      Boolean   @default(false)  // 是否被封禁
  banReason     String?   // 封禁原因
  bannedAt      DateTime? // 封禁时间
  lastIpLocation  String?  // 最后一次 IP 属地
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  loginSessions    LoginSession[]
  videos           Video[]
  series           Series[]
  favorites        Favorite[]
  watchHistory     WatchHistory[]
  likes            Like[]
  dislikes         Dislike[]
  confused         Confused[]
  playlists        Playlist[]
  comments         Comment[]         @relation("CommentAuthor")
  commentRepliesTo Comment[]         @relation("CommentReplyTo")
  commentReactions CommentReaction[]
  devices          UserDevice[]
  searchRecords    SearchRecord[]

  @@index([email])
  @@index([username])
}

enum Role {
  USER
  ADMIN
  OWNER  // 站长，拥有最高权限
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// 登录会话追踪（用于 JWT 策略下的会话管理）
model LoginSession {
  id             String   @id @default(cuid())
  userId         String
  jti            String   @unique // JWT ID，用于撤销
  
  // 登录信息
  deviceType     String?  // desktop, mobile, tablet
  os             String?  // Windows, iOS, Android
  osVersion      String?
  browser        String?  // Chrome, Safari, Firefox
  browserVersion String?
  brand          String?  // Apple, Samsung
  model          String?  // iPhone 15
  userAgent      String?
  ipv4Address    String?
  ipv4Location   String?
  ipv6Address    String?
  ipv6Location   String?
  
  isRevoked      Boolean  @default(false) // 是否已撤销
  revokedAt      DateTime?
  
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  lastActiveAt   DateTime @default(now())
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([jti])
  @@index([lastActiveAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 邮件验证码
model VerificationCode {
  id        String           @id @default(cuid())
  email     String
  code      String
  type      VerificationType
  expiresAt DateTime
  used      Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([email, type])
  @@index([expiresAt])
}

enum VerificationType {
  REGISTER
  LOGIN
  RESET_PASSWORD
  CHANGE_EMAIL
}

// ==================== 视频相关 ====================

model Video {
  id          String      @id // 随机 6 位数字 ID (000000-999999)
  title       String
  description String?     @db.Text
  coverUrl    String?     // 可选，不填则显示默认封面
  videoUrl    String
  duration    Int?
  views       Int         @default(0)
  status      VideoStatus @default(PENDING)
  pages       Json?       // B站分P信息 [{ page: number, title: string, cid?: number }]
  
  // 扩展信息 (结构化)
  extraInfo   Json?       // { 
                          //   intro?: string,           // 作品介绍
                          //   episodes?: { title: string, content: string }[], // 剧集介绍
                          //   author?: string,          // 原作者
                          //   authorIntro?: string,     // 作者介绍
                          //   keywords?: string[],      // 搜索关键词
                          //   downloads?: { name: string, url: string, password?: string }[], // 下载链接
                          //   relatedVideos?: string[], // 相关视频标题
                          //   notices?: { type: 'info'|'success'|'warning'|'error', content: string }[] // 公告
                          // }
  
  tags        TagOnVideo[]
  
  uploaderId  String
  uploader    User        @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  
  // 合集关联
  seriesEpisodes SeriesEpisode[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  favorites     Favorite[]
  watchHistory  WatchHistory[]
  likes         Like[]
  dislikes      Dislike[]
  confused      Confused[]
  playlistItems PlaylistItem[]
  comments      Comment[]

  @@index([uploaderId])
  @@index([status])
  @@index([createdAt])
}

// 合集/剧集
model Series {
  id           String   @id @default(cuid())
  title        String
  description  String?  @db.Text
  coverUrl     String?  // 合集封面
  downloadUrl  String?  // 下载链接
  downloadNote String?  @db.Text // 下载提示
  
  creatorId   String
  creator     User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  episodes    SeriesEpisode[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([creatorId])
  @@index([createdAt])
}

// 合集-视频关联（剧集）
model SeriesEpisode {
  id          String   @id @default(cuid())
  seriesId    String
  videoId     String
  episodeNum  Int      // 集数
  episodeTitle String? // 集标题（可选，默认使用视频标题）
  
  series      Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@unique([seriesId, videoId])
  @@unique([seriesId, episodeNum])
  @@index([seriesId])
  @@index([videoId])
}

enum VideoStatus {
  PENDING
  PUBLISHED
  REJECTED
  DELETED
}


model Tag {
  id        String       @id @default(cuid())
  name      String       @unique
  slug      String       @unique
  createdAt DateTime     @default(now())

  videos TagOnVideo[]

  @@index([slug])
}

model TagOnVideo {
  videoId String
  tagId   String
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([videoId, tagId])
  @@index([tagId])
}

// ==================== 用户交互 ====================

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  videoId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  videoId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

model Dislike {
  id        String   @id @default(cuid())
  userId    String
  videoId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

model Confused {
  id        String   @id @default(cuid())
  userId    String
  videoId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
}

model WatchHistory {
  id         String   @id @default(cuid())
  userId     String
  videoId    String
  progress   Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
  @@index([updatedAt])
}

model Playlist {
  id          String   @id @default(cuid())
  name        String
  description String?
  isPublic    Boolean  @default(true)
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items PlaylistItem[]

  @@index([userId])
}

model PlaylistItem {
  id         String   @id @default(cuid())
  playlistId String
  videoId    String
  sortOrder  Int      @default(0)
  addedAt    DateTime @default(now())

  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  video    Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([playlistId, videoId])
  @@index([playlistId])
  @@index([videoId])
}

// ==================== 评论系统 ====================

model Comment {
  id            String   @id @default(cuid())
  content       String   @db.Text
  userId        String?  // 可选，匿名评论时为 null
  videoId       String
  parentId      String?  // 回复的父评论 ID（顶级评论的 ID）
  replyToUserId String?  // 回复的目标用户 ID（用于 @用户名 显示）
  
  // 访客信息（匿名评论时使用）
  guestName     String?  // 访客昵称
  guestEmail    String?  // 访客邮箱
  guestWebsite  String?  // 访客网址
  
  ipv4Address   String?
  ipv4Location  String?
  ipv6Address   String?
  ipv6Location  String?
  deviceInfo    Json?
  userAgent     String?
  
  likes     Int      @default(0)
  dislikes  Int      @default(0)
  
  isEdited  Boolean  @default(false)
  isPinned  Boolean  @default(false)
  isDeleted Boolean  @default(false) // 软删除
  isHidden  Boolean  @default(false) // 后台隐藏
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User?         @relation("CommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  video       Video         @relation(fields: [videoId], references: [id], onDelete: Cascade)
  parent      Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies     Comment[]     @relation("CommentReplies")
  replyToUser User?         @relation("CommentReplyTo", fields: [replyToUserId], references: [id], onDelete: SetNull)
  reactions   CommentReaction[]

  @@index([videoId, createdAt])
  @@index([videoId, likes])
  @@index([userId])
  @@index([parentId])
}

model UserDevice {
  id             String   @id @default(cuid())
  userId         String
  fingerprint    String
  deviceType     String?  // desktop, mobile, tablet
  os             String?  // Windows, iOS, Android
  osVersion      String?
  browser        String?  // Chrome, Safari, Firefox
  browserVersion String?
  brand          String?  // Apple, Samsung, Xiaomi
  model          String?  // iPhone 15, Galaxy S24
  userAgent      String?
  ipv4Address    String?
  ipv4Location   String?
  ipv6Address    String?
  ipv6Location   String?
  lastActiveAt   DateTime @default(now())
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fingerprint])
  @@index([userId])
  @@index([lastActiveAt])
}

model CommentReaction {
  id        String   @id @default(cuid())
  userId    String
  commentId String
  isLike    Boolean  // true = 赞, false = 踩
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

// ==================== 搜索记录 ====================

model SearchRecord {
  id        String   @id @default(cuid())
  keyword   String
  userId    String?  // 可选，匿名用户也可以记录
  resultCount Int    @default(0) // 搜索结果数量
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([keyword])
  @@index([createdAt])
  @@index([userId])
}

// ==================== 网站配置 ====================

model SiteConfig {
  id        String   @id @default("default") // 单例模式，只有一条记录
  
  // 基本信息
  siteName        String   @default("Mikiacg")
  siteDescription String?  @db.Text
  siteLogo        String?  // Logo URL
  siteFavicon     String?  // Favicon URL
  siteKeywords    String?  // SEO 关键词，逗号分隔
  
  // 公告
  announcement    String?  @db.Text  // 公告内容（支持 Markdown）
  announcementEnabled Boolean @default(false)
  
  // 功能开关
  allowRegistration   Boolean @default(true)   // 允许注册
  allowUpload         Boolean @default(true)   // 允许上传
  allowComment        Boolean @default(true)   // 允许评论
  requireEmailVerify  Boolean @default(false)  // 注册需要邮箱验证
  
  // 内容设置
  videosPerPage       Int     @default(20)     // 每页视频数
  commentsPerPage     Int     @default(20)     // 每页评论数
  maxUploadSize       Int     @default(500)    // 最大上传大小 (MB)
  allowedVideoFormats String  @default("mp4,webm,m3u8") // 允许的视频格式
  
  // 联系方式
  contactEmail    String?
  socialLinks     Json?    // { github?: string, twitter?: string, discord?: string, ... }
  
  // 页脚
  footerText      String?  @db.Text  // 自定义页脚文本
  footerLinks     Json?    // [{ label: string, url: string }]
  
  // ICP 备案
  icpBeian        String?  // ICP 备案号
  publicSecurityBeian String? // 公安备案号
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
