# ACGN Platform - 公网机 Nginx 配置
# 适配 nginx mainline v1.29.4
# 放置于 /etc/nginx/sites-available/app.conf

upstream acgn_web {
    server 127.0.0.1:1270;  # rathole 转发的 Next.js
    keepalive 32;
    keepalive_requests 1000;
    keepalive_timeout 60s;

    # 健康检查（需要 nginx-plus 或使用备用方案）
    # 如果上游不可用，快速失败而不是长时间等待
}

# 限流配置
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;

# HTTP 全域名 catch-all -> 301 重定向到主域名
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    # Let's Encrypt 验证（必须保留，否则无法续签证书）
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://www.example.com$request_uri;
    }
}

# HTTPS 全域名 catch-all -> 301 重定向到主域名
# 通过 IP 或其他域名的 HTTPS 访问会先看到证书警告，确认后 301 跳转
server {
    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;
    http2 on;
    server_name _;

    ssl_certificate /etc/letsencrypt/live/www.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.example.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    return 301 https://www.example.com$request_uri;
}

# HTTPS 主配置
server {
    # HTTP/2 (nginx 1.25.1+ 使用独立指令)
    listen 443 ssl;
    listen [::]:443 ssl;
    
    # HTTP/3 QUIC (nginx 1.25+)
    listen 443 quic reuseport;
    listen [::]:443 quic reuseport;
    
    http2 on;
    http3 on;
    
    server_name www.example.com;

    # SSL 证书 (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/www.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.example.com/privkey.pem;
    
    # 现代 TLS 配置 (仅 TLS 1.3 + 安全 TLS 1.2)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers off;
    ssl_ecdh_curve X25519:secp384r1;
    
    # SSL 会话优化
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    
    # OCSP Stapling (Let's Encrypt ACME 证书不支持)
    # ssl_stapling on;
    # ssl_stapling_verify on;
    # ssl_trusted_certificate /etc/letsencrypt/live/www.example.com/chain.pem;
    # resolver 1.1.1.1 8.8.8.8 valid=300s;
    # resolver_timeout 5s;
    
    # HTTP/3 Alt-Svc 头
    add_header Alt-Svc 'h3=":443"; ma=86400' always;
    
    # HSTS (包含子域名)
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # 现代安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    # 禁用浏览器地理定位
    add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    # add_header Cross-Origin-Embedder-Policy "credentialless" always;  # 可能影响浏览器扩展

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types 
        text/plain 
        text/css 
        text/xml 
        text/javascript
        application/json 
        application/javascript 
        application/xml
        application/rss+xml 
        application/atom+xml 
        image/svg+xml
        font/woff
        font/woff2;

    # Brotli 压缩 (需要 ngx_brotli 模块)
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css text/xml application/json application/javascript application/xml application/rss+xml image/svg+xml;

    # 早期提示 (103 Early Hints) - nginx 1.25.3+
    # 可用于预加载关键资源
    # add_header Link "</style.css>; rel=preload; as=style" early_hints;

    # SEO 文件缓存
    location = /sitemap.xml {
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_valid 200 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    location = /robots.txt {
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_valid 200 1d;
        add_header Cache-Control "public, max-age=86400";
    }

    location = /feed.xml {
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_valid 200 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    location = /llms.txt {
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_valid 200 1d;
        add_header Cache-Control "public, max-age=86400";
    }

    location /.well-known/ {
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_valid 200 1d;
        add_header Cache-Control "public, max-age=86400";
    }

    # tRPC API 限流
    location /api/trpc/ {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # 其他 API 限流
    location /api/ {
        limit_req zone=api burst=30 nodelay;
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 上传大小限制
        client_max_body_size 50M;
    }

    # Next.js 静态资源
    location /_next/static/ {
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 长期缓存
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # 上传文件
    location /uploads/ {
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 缓存上传文件
        proxy_cache_valid 200 30d;
        add_header Cache-Control "public, max-age=2592000";
    }

    # Service Worker
    location = /sw.js {
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SW 不缓存
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Next.js 应用 (默认)
    location / {
        limit_req zone=general burst=50 nodelay;
        proxy_pass http://acgn_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # 自定义错误页面
    # 注意：proxy_next_upstream 重试仅在有多个上游服务器时有效
    # 当前 upstream 只有单服务器，无法实现故障转移
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
}
